name: Coral Base EE PR Workflow

on:
  pull_request:
    paths:
      - 'apps/coral-base/**'
env:
  OCTOPUS_URL: ${{ vars.DEMO_OCTOPUS_URL }}
  OCTOPUS_SPACE: ${{ vars.DEMO_OCTOPUS_SPACE }}
  SERVICE_ACCOUNT_ID: 4d50c8ac-1515-4351-96a7-4a82d55d55ff    
jobs:
  determine-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.set-version.outputs.VERSION }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Set version
        id: set-version
        run: echo "VERSION=$(date +'%Y%m%d').${{ github.run_number }}.${{ github.run_attempt }}-pr-${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
        shell: bash

  create-octopus-release:
    name: Create Octopus Release ğŸ™
    permissions:
      id-token: write
    needs: [determine-version]
    runs-on: ubuntu-latest
    steps:
    - name: Login to Octopus Deploy ğŸ™
      uses: OctopusDeploy/login@v1
      with: 
        server: ${{ env.OCTOPUS_URL }}
        service_account_id: ${{ env.SERVICE_ACCOUNT_ID }}
    - name: Create Octopus Release ğŸ™
      uses: OctopusDeploy/create-release-action@v3
      id: "create-release"
      with:
        project: "Coral Base - EE"
        release_number: ${{ needs.determine-version.outputs.version }}
        custom_fields: |
            PullRequestNumber: ${{ github.event.pull_request.number }}
    outputs: 
      release_number: ${{ steps.create-release.outputs.release_number }}
